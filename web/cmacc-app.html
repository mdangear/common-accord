<!-- Imports polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">


<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">

<link rel="import" href="./cmacc-ast.html">
<link rel="import" href="./cmacc-document.html">
<link rel="import" href="./cmacc-sidebar.html">
<link rel="import" href="./cmacc-dialog.html">

<dom-module id="cmacc-app">

    <style>
        #container {
            background-color: #dddddd;
            height: 100%;
            padding: 50px;
            overflow: scroll;
        }

        #page {
            width: 80%;
            min-height: 80%;
            margin: auto;
            padding: 20px;
            background: #FFF;
            box-shadow: 10px 10px 5px #888888;
        }

    </style>

    <template>
        <cmacc-ast id="ast" ast="{{ast}}"></cmacc-ast>
        <cmacc-dialog id="dialog" ast="{{ast}}"></cmacc-dialog>
        <app-drawer-layout fullbleed>

            <div id="container">
                <div id="page">
                    <cmacc-document ast="{{ast}}"></cmacc-document>
                </div>

            </div>

            <app-drawer align="right">
                <cmacc-sidebar ast="{{ast}}"></cmacc-sidebar>
            </app-drawer>

        </app-drawer-layout>
    </template>
</dom-module>


<script>
    Polymer({
        is: 'cmacc-app',

        properties: {
            ast: {
                type: Object,
                observer: 'refresh'
            }
        },

        ready: function () {
            this.addEventListener("cmacc-variable", function (e) {
                var ref = e.detail.data;
                console.log(e.detail.data);
                this.$.dialog.open(ref)
            }.bind(this), true);

            this.addEventListener("ast-changed", function (e) {
                console.log(e.detail.data);
            }.bind(this), true);

        },
        attached: function () {
            console.log(this.getDoc());
            this.$.ast.file = this.getDoc()
        },
        refresh: function () {
            console.log('refresh');
        },
        getDoc: function () {
            var url = window.location.href;
            var name = 'doc';
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
    });
</script>